@page "/User/Files"
@layout MainLayout
@using DocsMan.Blazor.Shared.DTOs

<PageTitle>FilesManager</PageTitle>

<h3 class="page-title">FilesManager</h3>

<div class="fm-box">
	<div class="fm-tools">
		<ul>
			<li @onclick="LoadDocs" class="tool-update">
				<i class="fas fa-sync-alt"></i>
			</li>
		</ul>
		<div class="file-tool">
			<ul>
				<li @onclick="()=>ChangeStyle(0)" class="tool @toolList[0].BlockStyle">
					<i class="fas fa-file-upload"></i>
				</li>
				<li @onclick="()=>ChangeStyle(1)" class="tool @toolList[1].BlockStyle">
					<i class="fas fa-pen"></i>
				</li>
				<li class="tool @toolList[2].BlockStyle">
					<i class="fas fa-file-download"></i>
				</li>
				<li class="tool @toolList[3].BlockStyle">
					<i class="fas fa-trash-alt"></i>
				</li>
				<li @onclick="()=>ChangeStyle(4)" class="tool @toolList[4].BlockStyle">
					<i class="fas fa-history"></i>
				</li>
				<li @onclick="()=>ChangeStyle(5)" class="tool @toolList[5].BlockStyle">
					<i class="fas fa-info"></i>
				</li>
			</ul>
		</div>

		<div class="folder-tool">
			<ul>
				<li class="tool @toolList[6].BlockStyle">
					<i class="fas fa-folder-plus"></i>
				</li>
				<li @onclick="()=>ChangeStyle(7)" class="tool @toolList[7].BlockStyle">
					<i class="fas fa-edit"></i>
				</li>
				<li class="tool @toolList[8].BlockStyle">
					<i class="fas fa-folder-minus"></i>
				</li>
				<li @onclick="()=>ChangeStyle(9)" class="tool @toolList[9].BlockStyle">
					<i class="fas fa-info"></i>
				</li>
			</ul>
		</div>

	</div>

	<div class="fm-workspace">
		@if (loading)
		{
			<SpinnerLoading />
		}
		else
		{
			<div class="fm-upload @toolList[0].BlockStyle">
				<div class="dm-add-new">
					<div class="set-data">
						<label for="o-file">Upload File</label>
						<br>
						<InputFile OnChange="OnInputFile" id="o-file"></InputFile>
						<button @onclick="@SendFile" class="dm-btn create">Create Document</button>
					</div>
				</div>
			</div>

			<div class="fm-docslist">
				<ul>
					@foreach (var item in docs)
					{
						<li @onclick="() => SelectDoc(item)" class="document @item.Style.BlockStyle">
							<i class="fas fa-file-word"></i>
							<div class="doc-name">
								@item.Document.Name@item.Document.FileType
							</div>
						</li>
					}
				</ul>
			</div>
			@if (selectedDoc != null)
			{
				<div class="fm-info @toolList[5].BlockStyle">

					<label for="name">DocName:</label>
					<p id="name">@selectedDoc.Name</p>
					<label for="type">DocType:</label>
					<p id="type">@selectedDoc.FileType</p>
					<label for="desc">DocDesc:</label>
					<p id="desc">@selectedDoc.Description</p>
					<label for="size">DocSize:</label>
					<p id="size">@selectedDoc.FileSize</p>

				</div>
			}
		}
	</div>
	

</div>

<ResponseResultPage RequestResult="@resp" IsWasSendRequest="@isClick" OpenCloseStyles="@CSS_Styles.OpenCloseStyles" />

@code {

	bool loading = true;
	bool isClick = false;
	RequestResultDto? resp;

	protected override async void OnInitialized()
	{
		loading = true;

		toolList[0].IsDisabled = false;
		toolList[6].IsDisabled = false;

		await LoadDocs();

		await Task.Delay(500);
		loading = false;
		StateHasChanged();
	}
	
	List<(DocumentDto Document, ToggleStyleCSS Style)> docs = new();
	async Task LoadDocs()
	{
		isClick = true;
		loading = true;

		var req = await new ServerGet<IEnumerable<DocumentDto>?>(WebCooker)
			.DoRequest_GET("FileManager/GetDocs");

		docs = new();
		if (req.Response.IsSuccess)
			if (req.Value != null)
			{
				foreach (var item in req.Value)
				{
					docs.Add(new(item, new ToggleStyleCSS("", "selected", "")));
				}
				docs.ForEach(x => x.Style.IsDisabled = false);
			}
		resp = req;

		await Task.Delay(500);
		loading = false;
	}

	List<ToggleStyleCSS> toolList = new()
	{
		new("", "open", ""), new("", "open", "disabled"),
		new("", "", "disabled"), new("", "", "disabled"),
		new("", "open", "disabled"), new("", "open", "disabled"),
		new("", "", ""), new("", "open", "disabled"),
		new("", "", "disabled"), new("", "open", "disabled"),
	};
	void ChangeStyle(int id)
	{
		if (id == 0 || id == 6)
			toolList[id].IsOpen = !toolList[id].IsOpen;
		else
		if (selectedDoc != null)
			toolList[id].IsOpen = !toolList[id].IsOpen;
	}

	DocumentDto selectedDoc;
	void SelectDoc((DocumentDto Document, ToggleStyleCSS Style) doc)
	{
		for (int i = 0; i < docs.Count; i++)
		{
			if ( docs[i].Document.Id != doc.Document.Id )
				docs[i].Style.IsOpen = false;
			else
				doc.Style.IsOpen = !doc.Style.IsOpen;
		}
		if ( doc.Style.IsOpen )
		{
			selectedDoc = doc.Document;
			for ( int i = 1; i <= 5; i++ )
				toolList[i].IsDisabled = false;
		}
		else
		{
			selectedDoc = null;
			for (int i = 1; i <= 5; i++)
			{
				toolList[i].IsOpen = false;
				toolList[i].IsDisabled = true;
			}
		}
	}

	bool fileUploaded = false;
	DataFile newFile = new();
	async Task OnInputFile(InputFileChangeEventArgs e)
	{
		var file = e.GetMultipleFiles().FirstOrDefault();
		if (file == null)
		{
			fileUploaded = false;
			return;
		}
		else
		{
			fileUploaded = true;
			newFile.FileName = file.Name;
			using (var ms = new MemoryStream())
			{
				await file.OpenReadStream(maxAllowedSize: 102400000).CopyToAsync(ms);
				newFile.FileData = ms.ToArray();
			}
		}
	}

	async Task SendFile()
	{
		if (!fileUploaded)
			return;

		isClick = true;
		loading = true;

		resp = await new ServerPost<DataFile>(WebCooker)
		.DoRequest_POST("FileManager/AddDocument", newFile);

		await Task.Delay(500);
		loading = false;
		StateHasChanged();
	}
}