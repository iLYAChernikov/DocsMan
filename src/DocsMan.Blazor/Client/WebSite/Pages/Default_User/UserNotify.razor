@page "/User/Notify"
@layout MainLayout
@using DocsMan.Blazor.Shared.DTOs

<PageTitle>UserNotify</PageTitle>

<h3 class="page-title">UserNotify</h3>

@if (loading)
{
	<SpinnerLoading />
}
else
{
	<div class="notify-page">

		@if (messages != null)
		{
			@foreach (var item in messages)
			{
				<div class="msg">

					@if (item.IsRead)
					{
						<div class="point" @onclick="()=>ForgetNotify(item.Id)">
							<i class="fa-regular fa-circle"></i>
						</div>
					}
					else
					{
						<div class="point" @onclick="()=>ReadNotify(item.Id)">
							<i class="fa-solid fa-circle"></i>
						</div>
					}

					<h3>@item.Title</h3>
					<p>@item.Description</p>
					<p>@item.DateTime.ToShortDateString() @item.DateTime.ToLongTimeString()</p>
				</div>
			}
		}

	</div>
}

<ResponseResultPage RequestResult="@resp" IsWasSendRequest="@isClick" OpenCloseStyles="@CSS_Styles.OpenCloseStyles" />

@code {
	bool loading = false;
	RequestResultDto? resp;
	bool isClick = false;

	protected override async Task OnInitializedAsync()
	{
		loading = true;

		await LoadNotify();

		await Task.Delay(500);
		loading = false;
		StateHasChanged();
	}

	IEnumerable<NotificationDto>? messages;

	async Task LoadNotify()
	{
		var req = await new ServerGet<IEnumerable<NotificationDto>?>(WebCooker)
		.DoRequest_GET("Profile/GetNotify");
		messages = req.Value;

		StateHasChanged();
	}

	async Task ReadNotify(int id)
	{
		await new ServerDelete(WebCooker)
			.DoRequest_DELETE($"Notify/Read/{id}");

		await LoadNotify();
	}

	async Task ForgetNotify(int id)
	{
		await new ServerDelete(WebCooker)
			.DoRequest_DELETE($"Notify/Forget/{id}");

		await LoadNotify();
	}
}