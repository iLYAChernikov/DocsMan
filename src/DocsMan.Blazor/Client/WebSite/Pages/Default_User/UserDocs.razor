@page "/User/Docs/{ProfileId:int?}"
@layout MainLayout
@using DocsMan.Blazor.Shared.DTOs

<PageTitle>UserDocs</PageTitle>

<h3 class="page-title">UserDocs</h3>

@if (loading)
{
	<SpinnerLoading />
}
else
{
	@if (docs != null)
	{
		<table class="dm-table">
			<tr>
				<td>TypeName</td>
				<td>Text</td>
				<td>Download</td>
				<td>Delete</td>
			</tr>
			@foreach (var item in docs)
			{
				<tr>
					<td>@item.PersonalDocumentType.Title</td>
					<td>@item.Text</td>
					<td>
						<a class="link-icon">
							<i class="fas fa-download"></i>
						</a>
					</td>
					<td>
						<a class="delete-icon">
							<i class="fas fa-trash"></i>
						</a>
					</td>
				</tr>
			}
		</table>
	}
}

<ResponseResultPage RequestResult="@resp" IsWasSendRequest="@isClick" OpenCloseStyles="@CSS_Styles.OpenCloseStyles" />

@code {
	[Parameter]
	public int ProfileId { get; set; } = 0;

	bool loading = true;
	bool isClick = false;
	RequestResultDto? resp;
	IEnumerable<PersonalDocumentDto>? docs;

	protected override async void OnInitialized()
	{
		isClick = true;
		if (ProfileId <= 0)
		{
			ProfileId = await GetProfileId();
		}
		else
		{
			if (ProfileId != await GetProfileId() && !await IsAdminCheck())
			{
				PagesNavigation.NavigateTo("/User/Docs");
			}
		}
		var req = await new ServerGet<IEnumerable<PersonalDocumentDto>>(WebCooker)
		.DoRequest_GET($"Profile/GetPersonalDocs/{ProfileId}");

		resp = req;
		docs = req.Value;

		await Task.Delay(500);
		loading = false;
		StateHasChanged();
	}

	async Task<int> GetProfileId()
	{
		var id_resp = await new ServerGet<int>(WebCooker)
		.DoRequest_GET("Auth/GetProfileId");
		if (id_resp.Response.IsSuccess)
			return id_resp.Value;
		else
		{
			resp = id_resp;
			return 0;
		}
	}

	async Task<bool> IsAdminCheck()
	{
		var prof = await new ServerGet<ProfileDto>(WebCooker)
		.DoRequest_GET($"Profile/GetOneById/{ProfileId}");
		if (prof == null || !prof.Response.IsSuccess)
		{
			resp = prof;
			return false;
		}
		var req = await new ServerGet<bool>(WebCooker)
		.DoRequest_GET("Auth/IsAdmin");
		if (req != null)
			return req.Value;
		else
			return false;
	}
}